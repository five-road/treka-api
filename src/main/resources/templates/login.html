<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>로그인</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f5f5f5;
            margin: 0;
            font-family: sans-serif;
        }
        .login-container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 350px;
            text-align: center;
        }
        .login-container h1 {
            margin-bottom: 30px;
            color: #FAA5A5;
        }
        .social-login-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        .kakao-login-button {
            background-color: #FEE500;
            color: #191919;
        }
        .google-login-button {
            background-color: #FFFFFF;
            color: #757575;
            border: 1px solid #dddddd;
        }
        .social-login-button img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: #aaa;
            margin: 20px 0;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #eee;
        }
        .divider:not(:empty)::before {
            margin-right: .25em;
        }
        .divider:not(:empty)::after {
            margin-left: .25em;
        }
        .login-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .login-form button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            background-color: #FAA5A5;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        .login-form button:hover {
            background-color: #FAA5A5;
        }


    </style>
</head>
<body>

<div class="login-container">
    <h1 class="logo">Treka</h1>
    <h3>로그인</h3>

    <!-- 일반 로그인 폼 -->
    <div class="login-form">
        <input type="email" id="email-input" placeholder="이메일" required>
        <input type="password" id="password-input" placeholder="비밀번호" required>
        <button id="login-button">로그인</button>
    </div>

    <div class="divider">또는</div>

    <!-- 소셜 로그인 버튼 -->
    <button class="social-login-button kakao-login-button" id="kakao-login-btn">
        카카오 로그인
    </button>
    <button class="social-login-button google-login-button" id="google-login-btn">
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="구글 심볼">
        구글 로그인
    </button>
</div>

<script th:inline="javascript">
    // Thymeleaf를 통해 서버에서 클라이언트 ID들을 가져옵니다.
    // 값이 없으면 null로 설정되어 || 연산자를 통해 대체 값을 사용하게 됩니다.
    const KAKAO_CLIENT_ID = /*[[${kakaoClientId}]]*/ null;
    const GOOGLE_CLIENT_ID = /*[[${googleClientId}]]*/ null;

    // 카카오 로그인 설정
    const kakaoLoginBtn = document.getElementById('kakao-login-btn');
    if (kakaoLoginBtn) {
        kakaoLoginBtn.addEventListener('click', () => {
            const REST_API_KEY = KAKAO_CLIENT_ID || 'YOUR_FALLBACK_KAKAO_KEY';
            const REDIRECT_URI = 'https://xn--hq1bm8jm9l/auth/kakao/callback';
            const kakaoAuthUrl = `https://kauth.kakao.com/oauth/authorize?client_id=${REST_API_KEY}&redirect_uri=${REDIRECT_URI}&response_type=code&state=kakao`;
            window.location.href = kakaoAuthUrl;
        });
    }

    // 구글 로그인 설정
    const googleLoginBtn = document.getElementById('google-login-btn');
    if (googleLoginBtn) {
        googleLoginBtn.addEventListener('click', () => {
            const CLIENT_ID = GOOGLE_CLIENT_ID || 'YOUR_FALLBACK_GOOGLE_KEY';
            // 중요: 이 URI는 Google Cloud Console에 등록된 리디렉션 URI와 정확히 일치해야 합니다.
            // 127.0.0.1을 사용하는 이유는 Google의 최신 보안 정책 때문입니다.
            const REDIRECT_URI = 'https://xn--hq1bm8jm9l/auth/google/callback';
            const scope = 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';
            const googleAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=code&scope=${scope}&state=google`;
            window.location.href = googleAuthUrl;
        });
    }

    // 일반 로그인 처리
    const loginButton = document.getElementById('login-button');
    if (loginButton) {
        loginButton.addEventListener('click', () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                alert('이메일과 비밀번호를 모두 입력해주세요.');
                return;
            }

            fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email, password: password }),
            })
            .then(response => {
                if (!response.ok) {
                    // 로그인 실패 시 서버에서 보낸 에러 메시지를 파싱
                    return response.json().then(err => { throw new Error(err.message || '로그인에 실패했습니다.') });
                }
                // 성공 시 토큰을 포함한 응답을 JSON으로 파싱
                return response.json();
            })
            .then(data => {
                // 서버 응답에서 accessToken과 refreshToken을 가져옴
                const { accessToken, refreshToken } = data.data;
                if (accessToken && refreshToken) {
                    // 토큰을 로컬 스토리지에 저장
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    alert('로그인 성공!');
                    // 로그인 성공 후 이동할 페이지 (예: /home)
                    window.location.href = '/home';
                } else {
                    throw new Error('토큰이 반환되지 않았습니다.');
                }
            })
            .catch(error => {
                console.error('Login failed:', error);
                alert(error.message);
            });
        });
    }


    // 페이지 로드 시 소셜 로그인 콜백 처리
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state'); // 'kakao' 또는 'google'

        if (code && state) {
            let provider = '';
            if (state === 'google') {
                provider = 'google';
            }
            // 참고: 현재 카카오 로직은 백엔드에서 직접 리디렉션을 처리하므로,
            // 이 프론트엔드 콜백 핸들러는 주로 구글 및 향후 추가될 소셜 로그인을 위해 사용됩니다.
            // 만약 카카오도 프론트에서 토큰을 받아 처리하려면 카카오의 REDIRECT_URI를 이 페이지로 변경해야 합니다.

            if (provider) {
                fetch(`/api/v1/auth/${provider}/code?code=${code}`, {
                    method: 'GET',
                })
                .then(response => response.json())
                .then(data => {
                    const { accessToken, refreshToken } = data.data;
                    if (accessToken && refreshToken) {
                        localStorage.setItem('accessToken', accessToken);
                        localStorage.setItem('refreshToken', refreshToken);

                        // URL에서 code와 state 파라미터 정리
                        const newUrl = window.location.pathname;
                        history.replaceState({}, document.title, newUrl);

                        alert('소셜 로그인 성공!');
                        window.location.href = '/home'; // 로그인 성공 후 이동할 페이지
                    } else {
                        throw new Error('소셜 로그인에 실패했습니다: ' + (data.message || '토큰을 받지 못했습니다.'));
                    }
                })
                .catch(error => {
                    console.error('Social login error:', error);
                    alert(error.message);
                });
            }
        }
    };
</script>
</body>
</html>
