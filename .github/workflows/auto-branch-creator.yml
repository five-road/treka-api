# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: ğŸ¤– Auto Branch Creator with Labels

# ì‹¤í–‰ ì¡°ê±´: ì´ìŠˆê°€ ìƒì„±ë˜ê±°ë‚˜, ë¼ë²¨ì´ ë¶™ì—ˆì„ ë•Œ ì‹¤í–‰
on:
  issues:
    types: [opened, labeled]

# ì‹¤í–‰í•  ì‘ì—…ë“¤
jobs:
  create_branch_job:
    runs-on: ubuntu-latest
    steps:
      # 1. ì´ìŠˆì˜ ë¼ë²¨ì„ ê¸°ë°˜ìœ¼ë¡œ ë¸Œëœì¹˜ ì ‘ë‘ì‚¬(prefix) ê²°ì •
      - name: Get branch prefix from label
        id: get_prefix
        run: |
          # ê¸°ë³¸ ì ‘ë‘ì‚¬ëŠ” 'feat'ìœ¼ë¡œ ì„¤ì •
          PREFIX="feat"
          
          # ì´ìŠˆì— ë¼ë²¨ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì²« ë²ˆì§¸ ë¼ë²¨ ì´ë¦„ì„ ê°€ì ¸ì˜´
          LABEL_NAME=$(jq -r '.issue.labels[0].name' "$GITHUB_EVENT_PATH")

          # ë¼ë²¨ ì´ë¦„ì— ë”°ë¼ ì ‘ë‘ì‚¬ ë³€ê²½
          case "$LABEL_NAME" in
            "ğŸ bug") PREFIX="fix" ;;
            "âœ¨ feature") PREFIX="feat" ;;
            "ğŸ”¨ refactor") PREFIX="refactor" ;;
            "ğŸš€ performance") PREFIX="performance" ;;
          esac
          
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT

      # 2. ì´ìŠˆ ì •ë³´ì™€ ì ‘ë‘ì‚¬ë¥¼ ì¡°í•©í•˜ì—¬ ìµœì¢… ë¸Œëœì¹˜ ì´ë¦„ í˜•ì‹ ë§Œë“¤ê¸°
      - name: Format branch name
        id: format_branch_name
        run: |
          # ìœ„ ë‹¨ê³„ì—ì„œ ê²°ì •ëœ ì ‘ë‘ì‚¬ë¥¼ ê°€ì ¸ì˜´
          branch_prefix="${{ steps.get_prefix.outputs.prefix }}"
          
          # ì´ìŠˆ ì œëª©ì„ ë¸Œëœì¹˜ ì´ë¦„ì— ë§ê²Œ ë³€í™˜ (ì†Œë¬¸ì, ê³µë°±/íŠ¹ìˆ˜ë¬¸ì -> í•˜ì´í”ˆ)
          branch_title=$(echo "${{ github.event.issue.title }}" | iconv -t ascii//TRANSLIT | sed -r 's/[^a-zA-Z0-9]+/-/g' | sed -r 's/^-+\|-+$//g' | tr 'A-Z' 'a-z')
          
          # ìµœì¢… ë¸Œëœì¹˜ ì´ë¦„ ì¡°í•©
          echo "branch=${branch_prefix}/${{ github.event.issue.number }}-${branch_title}" >> $GITHUB_OUTPUT

      # 3. ë§Œë“  ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ ì‹¤ì œ ë¸Œëœì¹˜ ìƒì„±
      - name: Create branch
        uses: actions/checkout@v4
        with:
          create-branch: true
          branch: ${{ steps.format_branch_name.outputs.branch }}
      
      # 4. ì´ìŠˆì— ë¸Œëœì¹˜ê°€ ìƒì„±ë˜ì—ˆìŒì„ ëŒ“ê¸€ë¡œ ì•Œë¦¼
      - name: Post comment to issue
        # ì´ìŠˆê°€ 'ìƒì„±'ë  ë•Œë§Œ ëŒ“ê¸€ì„ ì‘ì„±í•˜ì—¬ ë¼ë²¨ ë³€ê²½ ì‹œ ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€
        if: github.event.action == 'opened'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            âœ… ì´ ì´ìŠˆì™€ ì—°ê²°ëœ ë¸Œëœì¹˜ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            **ë¸Œëœì¹˜:** `${{ steps.format_branch_name.outputs.branch }}`
